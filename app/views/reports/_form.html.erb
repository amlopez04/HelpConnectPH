<%= form_with(model: report, data: { turbo: false }) do |f| %>
  <!-- Error Messages -->
  <% if report.errors.any? %>
    <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 rounded">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(report.errors.count, "error") %> prohibited this report from being saved:
          </h3>
          <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
            <% report.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Title -->
  <div class="mb-6">
    <%= f.label :title, "Report Title *", class: "block text-sm font-semibold text-gray-700 mb-2" %>
    <%= f.text_field :title, placeholder: "e.g., Flooding on Main Street", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", required: true %>
    <p class="text-xs text-gray-500 mt-1">Give your report a clear, descriptive title</p>
  </div>

  <!-- Description -->
  <div class="mb-6">
    <%= f.label :description, "Description *", class: "block text-sm font-semibold text-gray-700 mb-2" %>
    <%= f.text_area :description, rows: 6, placeholder: "Describe the issue in detail...", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", required: true %>
    <p class="text-xs text-gray-500 mt-1">Provide as much detail as possible about the issue</p>
  </div>

  <!-- Location Picker -->
  <div class="mb-6" data-controller="location-picker" data-location-picker-api-key-value="<%= ENV['GOOGLE_MAPS_API_KEY'] %>">
    <label class="block text-sm font-semibold text-gray-700 mb-2">üìç Location *</label>
    
    <!-- Map -->
    <div class="mb-4">
      <div 
        data-location-picker-target="map"
        class="w-full h-96 rounded-lg border-2 border-gray-300"
        style="min-height: 400px;">
      </div>
      <p class="text-xs text-gray-500 mt-2">
        üîµ Click on the map or drag the marker to set your exact location
        <br>üì± We'll try to detect your current location automatically
      </p>
    </div>

    <!-- Address Field -->
    <div class="mb-4">
      <%= f.label :address, "Address *", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <div class="flex gap-2">
        <%= f.text_field :address, 
            placeholder: "e.g., Main Street corner 5th Avenue, Barangay Name", 
            class: "flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",
            required: true,
            data: { location_picker_target: "address" } %>
        <button 
          type="button"
          data-location-picker-target="searchButton"
          data-action="click->location-picker#searchAddress"
          class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition whitespace-nowrap">
          üîç Search
        </button>
      </div>
      <p class="text-xs text-gray-500 mt-1">Type an address and click Search, or click/drag on the map</p>
    </div>

    <!-- Hidden Coordinate Fields -->
    <%= f.hidden_field :latitude, data: { location_picker_target: "latitude" } %>
    <%= f.hidden_field :longitude, data: { location_picker_target: "longitude" } %>
  </div>

  <!-- Barangay & Category (Side by Side) -->
  <div class="grid md:grid-cols-2 gap-6 mb-6">
    <!-- Barangay -->
    <div>
      <%= f.label :barangay_id, "Barangay *", class: "block text-sm font-semibold text-gray-700 mb-2" %>
      <%= f.collection_select :barangay_id, Barangay.all, :id, :name, { prompt: "Select Barangay", selected: current_user&.barangay_id }, { class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", required: true } %>
      <% if current_user&.barangay.present? %>
        <p class="text-xs text-gray-500 mt-1">Your barangay (<%= current_user.barangay.name %>) is pre-selected</p>
      <% end %>
    </div>

    <!-- Category -->
    <div>
      <%= f.label :category_id, "Category *", class: "block text-sm font-semibold text-gray-700 mb-2" %>
      <%= f.collection_select :category_id, Category.all, :id, :name, { prompt: "Select Category" }, { class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", required: true } %>
    </div>
  </div>

  <!-- Priority & Status (Side by Side) -->
  <div class="grid md:grid-cols-2 gap-6 mb-6">
    <!-- Priority -->
    <div>
      <%= f.label :priority, "Priority Level *", class: "block text-sm font-semibold text-gray-700 mb-2" %>
      <% if current_user.barangay_official? || current_user.admin? || report.new_record? %>
        <%= f.select :priority, Report.priorities.keys.map { |p| [p.titleize, p] }, { prompt: "Select Priority" }, { class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500", required: true } %>
        <% if report.new_record? %>
          <p class="text-xs text-gray-500 mt-1">Set the initial priority level</p>
        <% else %>
          <p class="text-xs text-gray-500 mt-1">Officials/Admins can update priority</p>
        <% end %>
      <% else %>
        <div class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50">
          <span class="<%= report.critical? ? 'text-red-600' : report.high? ? 'text-orange-600' : report.medium? ? 'text-yellow-600' : 'text-gray-600' %> font-semibold">
            <%= report.priority.titleize %>
          </span>
        </div>
        <p class="text-xs text-gray-500 mt-1">Only officials and admins can change priority</p>
        <%= f.hidden_field :priority %>
      <% end %>
    </div>

    <!-- Status (Only for Officials/Admins) -->
    <% if current_user.barangay_official? || current_user.admin? %>
      <div>
        <%= f.label :status, "Status", class: "block text-sm font-semibold text-gray-700 mb-2" %>
        <%= f.select :status, Report.statuses.keys.map { |s| [s.titleize, s] }, {}, { class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
        <p class="text-xs text-gray-500 mt-1">Officials/Admins can update status</p>
      </div>
    <% end %>
  </div>

  <!-- Photo Upload -->
  <div class="mb-6">
    <%= f.label :photos, "Photos (Optional)", class: "block text-sm font-semibold text-gray-700 mb-2" %>
    <%= f.file_field :photos, multiple: true, accept: "image/*", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    <p class="text-xs text-gray-500 mt-1">Upload photos of the issue (multiple files allowed)</p>
  </div>

  <!-- Submit Buttons -->
  <div class="flex gap-4">
    <%= f.submit class: "bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition cursor-pointer" %>
    <%= link_to "Cancel", reports_path, class: "bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-300 transition" %>
  </div>
<% end %>

