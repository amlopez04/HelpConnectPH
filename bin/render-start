#!/usr/bin/env bash
# Render startup script that runs migrations and seeds before starting the server
# This script is safe to run multiple times (idempotent)

echo "ğŸš€ Starting ParaÃ±aqueConnect deployment..."

# Wait for database to be ready (max 30 seconds)
echo "â³ Waiting for database connection..."
MAX_WAIT=30
WAIT_COUNT=0
until rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1; do
  if [ $WAIT_COUNT -ge $MAX_WAIT ]; then
    echo "âš ï¸  Database connection timeout after ${MAX_WAIT}s, continuing anyway..."
    break
  fi
  echo "   Database not ready yet, waiting... ($WAIT_COUNT/${MAX_WAIT}s)"
  sleep 2
  WAIT_COUNT=$((WAIT_COUNT + 2))
done

if rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" > /dev/null 2>&1; then
  echo "âœ… Database connected"
  
  # Run migrations
  echo "ğŸ“¦ Running database migrations..."
  if rails db:migrate; then
    echo "âœ… Migrations completed"
  else
    echo "âš ï¸  Migration failed, but continuing..."
  fi
  
  # Run seeds (only if RUN_SEEDS=true)
  if [ "$RUN_SEEDS" = "true" ]; then
    echo "ğŸŒ± Running database seeds..."
    if rails db:seed; then
      echo "âœ… Seeds completed"
    else
      echo "âš ï¸  Seeding failed, but continuing..."
    fi
  else
    echo "â„¹ï¸  Skipping seeds (set RUN_SEEDS=true to run seeds)"
  fi
else
  echo "âš ï¸  Could not connect to database. Migrations/seeds will be skipped."
  echo "âš ï¸  Server will start anyway, but database operations may fail."
fi

# Start the server
echo "ğŸš€ Starting Puma server..."
exec bundle exec puma -C config/puma.rb

